<!DOCTYPE html>
<html lang="bn">
<head>
    <title>টেলিগ্রাম WebApp লক সিস্টেম</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta charset="UTF-8">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; text-align: center; padding: 20px; margin: 0; height: 100vh; overflow: hidden; background: linear-gradient(135deg, #1a2a6c, #b21f1f); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; touch-action: none; position: fixed; width: 100%; top: 0; left: 0; }
        .container { background: rgba(0, 0, 0, 0.95); padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7); max-width: 400px; width: 95%; border: 3px solid #ff4444; }
        h1 { color: #fff; margin-bottom: 20px; font-size: 24px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); }
        #timer { font-size: 2.5em; color: #ffcc00; font-weight: bold; margin: 20px 0; text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.5); font-family: 'Courier New', monospace; }
        .progress-container { width: 100%; height: 15px; background: rgba(255, 255, 255, 0.2); border-radius: 10px; margin: 20px 0; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #ff416c, #ff4b2b); border-radius: 10px; transition: width 1s linear; }
        .message { margin-top: 15px; font-size: 14px; color: #ddd; line-height: 1.4; }
        .warning { color: #ff9999; font-size: 12px; margin-top: 10px; line-height: 1.4; }
        .navigation-blocked { color: #ff5555; font-weight: bold; margin-top: 15px; font-size: 16px; background: rgba(255, 0, 0, 0.2); padding: 8px; border-radius: 8px; }
        .hidden { display: none; }
        #popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.98); z-index: 10000; display: flex; justify-content: center; align-items: center; animation: fadeIn 0.3s ease-in; }
        .popup-content { background: linear-gradient(135deg, #dc143c, #b22222); padding: 25px; border-radius: 15px; text-align: center; max-width: 90%; width: 350px; border: 3px solid #ffcc00; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); animation: slideIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-50px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .popup-icon { font-size: 50px; margin-bottom: 15px; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        .popup-title { font-size: 20px; font-weight: bold; margin-bottom: 12px; color: white; }
        .popup-message { font-size: 14px; margin-bottom: 15px; color: #ffe6e6; line-height: 1.4; }
        .popup-penalty { font-size: 16px; font-weight: bold; color: #ffcc00; margin: 12px 0; padding: 8px; background: rgba(0, 0, 0, 0.3); border-radius: 8px; }
        #popup-close { background: #ffcc00; color: #b22222; border: none; padding: 10px 25px; font-size: 14px; font-weight: bold; border-radius: 20px; cursor: pointer; margin-top: 8px; transition: all 0.3s ease; }
        .nav-buttons-popup { display: flex; justify-content: center; margin: 15px 0; }
        .nav-button-popup { width: 40px; height: 40px; margin: 0 8px; background: rgba(255, 255, 255, 0.2); border: 2px solid #ffcc00; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 16px; }
        .attempt-counter { position: fixed; top: 10px; right: 10px; background: rgba(255, 0, 0, 0.8); color: white; padding: 4px 8px; border-radius: 5px; font-size: 12px; z-index: 999; }
        #auto-return-notice { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); background: rgba(255, 204, 0, 0.9); color: #b22222; padding: 8px 16px; border-radius: 20px; font-weight: bold; z-index: 10001; animation: pulse 2s infinite; font-size: 12px; }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #ffcc00; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
        .status-active { background: #4CAF50; animation: pulse 2s infinite; }
        .status-locked { background: #ff4444; }
        .firebase-status { margin-top: 10px; font-size: 12px; color: #888; }
        .telegram-blocked { background: rgba(255, 0, 0, 0.1); padding: 10px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #ff4444; }
    </style>
</head>
<body>
    <noscript>
        <div class="container">
            <h1>JavaScript নিষ্ক্রিয়!</h1>
            <p>দয়া করে JavaScript চালু করুন।</p>
        </div>
    </noscript>
    
    <div class="attempt-counter" id="attempt-counter">
        প্রচেষ্টা: <span id="attempt-count">0</span>
    </div>
    
    <div id="popup-overlay" class="hidden">
        <div class="popup-content">
            <div class="popup-icon">X</div>
            <div class="popup-title">টেলিগ্রাম সম্পূর্ণ লক!</div>
            <div class="nav-buttons-popup">
                <div class="nav-button-popup">←</div>
                <div class="nav-button-popup">O</div>
                <div class="nav-button-popup">Menu</div>
            </div>
            <div class="popup-message" id="popup-details">
                আপনি টেলিগ্রাম থেকে বের হওয়ার চেষ্টা করেছেন!<br>
                স্বয়ংক্রিয়ভাবে WebApp-এ ফিরে যাওয়া হচ্ছে...
            </div>
            <div class="popup-penalty" id="popup-penalty">
                +৩০ সেকেন্ড যোগ করা হয়েছে!
            </div>
            <div class="loading-spinner"></div>
            <button id="popup-close">WebApp-এ ফিরুন</button>
        </div>
    </div>

    <div id="auto-return-notice" class="hidden">
        WebApp-এ ফিরে যাওয়া হচ্ছে...
    </div>
    
    <div class="container">
        <h1>5 মিনিট অপেক্ষা করুন</h1>
        <div id="timer" aria-live="polite">5:00</div>
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        
        <div class="message">
            <span class="status-indicator status-active"></span>
            সিস্টেম সক্রিয়: <span id="user-id">লোড হচ্ছে...</span>
        </div>

        <div class="telegram-blocked">
            <strong>টেলিগ্রাম সম্পূর্ণ লকড:</strong>
            <div class="warning">
                • সব চ্যাট বন্ধ<br>
                • সব বট বন্ধ<br>
                • গ্রুপ/চ্যানেল বন্ধ<br>
                • কোনো মেসেজ পাঠানো যাবে না
            </div>
        </div>
        
        <p class="navigation-blocked">টাইমার শেষ না হওয়া পর্যন্ত টেলিগ্রাম ব্যবহার অসম্ভব</p>
        <p class="warning" id="connection-status">ফায়ারবেজ সংযোগ: চেক করা হচ্ছে...</p>
        <p class="firebase-status" id="firebase-status">Firebase: Connecting...</p>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const BOT_TOKEN = '8524488850:AAFEMnAhznZaCoGAkKNQviWmZVlQLB1DANE';
        const WEBAPP_BASE_URL = 'https://syd4t.github.io/MaillBee.X/';

        const firebaseConfig = {
            apiKey: "AIzaSyCho5RtEIoXnNlNNrpBg65BmTpJY23Se7Y",
            authDomain: "maillbeex.firebaseapp.com",
            databaseURL: "https://maillbeex-default-rtdb.firebaseio.com",
            projectId: "maillbeex",
            storageBucket: "maillbeex.firebasestorage.app",
            messagingSenderId: "5938669413",
            appId: "1:5938669413:web:34b6bbbbb0e81628a2a38c",
            measurementId: "G-F6YNLNQSK7"
        };

        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            document.getElementById('firebase-status').textContent = 'Firebase: Connected';
            document.getElementById('firebase-status').style.color = '#4CAF50';
        } catch (error) {
            console.error('Firebase error:', error);
            document.getElementById('firebase-status').textContent = 'Firebase: Failed';
            document.getElementById('firebase-status').style.color = '#ff4444';
        }

        let timeLeft = 300;
        let isLocked = true;
        let navButtonAttempts = 0;
        let isPopupShowing = false;
        let autoReturnTimer = null;
        let syncInterval = null;
        let userId = null;
        let isOnline = true;
        let lastPopupTime = 0;
        let alertMessageId = null;
        let notificationInterval = null;

        function initializeTelegramApp() {
            tg.ready();
            tg.expand();
            tg.disableClosingConfirmation();
            
            userId = tg.initDataUnsafe?.user?.id;
            if (userId) {
                document.getElementById('user-id').textContent = `ইউজার: ${userId}`;
                restoreFromFirebase();
            }
            
            initializeLockSystem();
        }

        function initializeLockSystem() {
            activateTelegramRestrictions();
            startFirebaseSync();
            setupEventListeners();
            startMainTimer();
            startNetworkMonitoring();
            if (isLocked) setTimeout(startPersistentAlert, 1000);
        }

        async function activateTelegramRestrictions() {
            try {
                await restrictUserInteractions();
                tg.showAlert("টেলিগ্রাম লকড! ৫ মিনিট অপেক্ষা করুন।");
                saveToFirebase();
            } catch (e) {}
        }

        async function restrictUserInteractions() {
            if (!userId) return;
            await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/restrictChatMember`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: userId,
                    user_id: userId,
                    permissions: {
                        can_send_messages: false,
                        can_send_media_messages: false,
                        can_send_polls: false,
                        can_send_other_messages: false,
                        can_add_web_page_previews: false,
                        can_change_info: false,
                        can_invite_users: false,
                        can_pin_messages: false
                    },
                    until_date: Math.floor(Date.now() / 1000) + 3600
                })
            });
        }

        async function unrestrictUserInteractions() {
            if (!userId) return;
            await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/restrictChatMember`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: userId,
                    user_id: userId,
                    permissions: {
                        can_send_messages: true,
                        can_send_media_messages: true,
                        can_send_polls: true,
                        can_send_other_messages: true,
                        can_add_web_page_previews: true,
                        can_change_info: true,
                        can_invite_users: true,
                        can_pin_messages: true
                    }
                })
            });
        }

        async function startPersistentAlert() {
            if (!userId || !isLocked || alertMessageId) return;

            const uniqueUrl = `${WEBAPP_BASE_URL}?t=${Date.now()}`;
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const timeStr = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            const message = `টেলিগ্রাম লকড! ${timeStr} বাকি\n\nবের হওয়ার চেষ্টা: ${navButtonAttempts}\n\nWebApp-এ ফিরে যান`;

            try {
                const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: userId,
                        text: message,
                        disable_notification: false,
                        protect_content: true,
                        reply_markup: {
                            inline_keyboard: [[{
                                text: "WebApp-এ ফিরুন",
                                web_app: { url: uniqueUrl }
                            }]]
                        }
                    })
                });
                const data = await res.json();
                if (data.ok) {
                    alertMessageId = data.result.message_id;
                    await pinMessage();
                    startNotificationUpdater();
                }
            } catch (e) { console.error(e); }
        }

        async function pinMessage() {
            if (!alertMessageId) return;
            await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/pinChatMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: userId,
                    message_id: alertMessageId,
                    disable_notification: false
                })
            });
        }

        async function updatePersistentAlert() {
            if (!alertMessageId || !isLocked) return;
            const uniqueUrl = `${WEBAPP_BASE_URL}?t=${Date.now()}`;
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const timeStr = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            const message = `বের হওয়া নিষেধ!\n\n⏳ বাকি: ${timeStr}\n\nWebApp-এ ফিরুন!`;

            await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/editMessageText`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: userId,
                    message_id: alertMessageId,
                    text: message,
                    disable_notification: false,
                    protect_content: true,
                    reply_markup: {
                        inline_keyboard: [[{
                            text: "WebApp-এ ফিরুন",
                            web_app: { url: uniqueUrl }
                        }]]
                    }
                })
            });
        }

        function startNotificationUpdater() {
            if (notificationInterval) clearInterval(notificationInterval);
            notificationInterval = setInterval(updatePersistentAlert, 15000);
        }

        async function deleteAndUnpinMessage() {
            if (!alertMessageId || !userId) return;
            try {
                await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/unpinChatMessage`, {
                    method: 'POST',
                    body: JSON.stringify({ chat_id: userId, message_id: alertMessageId })
                });
                await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/deleteMessage`, {
                    method: 'POST',
                    body: JSON.stringify({ chat_id: userId, message_id: alertMessageId })
                });
            } catch (e) {}
            alertMessageId = null;
            if (notificationInterval) clearInterval(notificationInterval);
        }

        function setupEventListeners() {
            document.addEventListener('visibilitychange', handleVisibilityChange);
            window.addEventListener('beforeunload', handleBeforeUnload);
            document.addEventListener('keydown', e => isLocked && e.preventDefault(), true);
            document.addEventListener('contextmenu', e => isLocked && e.preventDefault());
            window.addEventListener('online', () => { isOnline = true; updateConnectionStatus(true); });
            window.addEventListener('offline', () => { isOnline = false; updateConnectionStatus(false); });
            document.getElementById('popup-close').addEventListener('click', () => window.location.reload());
        }

        function handleVisibilityChange() {
            if (!isLocked || !document.hidden) return;
            navButtonAttempts++;
            updateAttemptCounter();
            const penalty = Math.min(60, navButtonAttempts * 15);
            timeLeft += penalty;
            updateTimerDisplay();
            document.getElementById('popup-penalty').textContent = `+${penalty} সেকেন্ড যোগ!`;
            showNavigationPopup("বের হওয়া নিষিদ্ধ!");
            startPersistentAlert();
            saveToFirebase();
            tg.HapticFeedback.impactOccurred('heavy');
        }

        function handleBeforeUnload(e) {
            if (isLocked) {
                e.preventDefault();
                e.returnValue = 'টাইমার শেষ না হওয়া পর্যন্ত বের হতে পারবেন না!';
            }
        }

        function startMainTimer() {
            const timer = setInterval(() => {
                if (!isLocked) { clearInterval(timer); return; }
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft % 10 === 0) saveToFirebase();
                if (timeLeft <= 0) { clearInterval(timer); unlockSystem(); }
            }, 1000);
        }

        async function unlockSystem() {
            isLocked = false;
            await unrestrictUserInteractions();
            await deleteAndUnpinMessage();
            if (db && userId) db.ref('users/' + userId).remove();
            if (syncInterval) clearInterval(syncInterval);
            tg.showAlert("টাইমার শেষ! টেলিগ্রাম ব্যবহার করুন।", () => tg.close());
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timer').textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            const progress = (300 - timeLeft) / 300 * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
        }

        function updateAttemptCounter() {
            document.getElementById('attempt-count').textContent = navButtonAttempts;
        }

        function updateConnectionStatus(connected) {
            const el = document.getElementById('connection-status');
            el.innerHTML = connected 
                ? 'নেটওয়ার্ক: <span style="color:#4CAF50">সংযুক্ত</span>'
                : 'নেটওয়ার্ক: <span style="color:#ff4444">বিচ্ছিন্ন</span>';
        }

        function showNavigationPopup(msg) {
            if (isPopupShowing) return;
            isPopupShowing = true;
            document.getElementById('popup-details').textContent = msg;
            document.getElementById('popup-overlay').classList.remove('hidden');
        }

        function saveToFirebase() {
            if (!db || !userId) return;
            db.ref('users/' + userId).set({ timeLeft, isLocked, attempts: navButtonAttempts, timestamp: Date.now() })
                .catch(() => {});
        }

        function restoreFromFirebase() {
            if (!db || !userId) return;
            db.ref('users/' + userId).once('value').then(snap => {
                const state = snap.val();
                if (state && state.isLocked && state.timeLeft > 0) {
                    timeLeft = state.timeLeft;
                    navButtonAttempts = state.attempts || 0;
                    updateTimerDisplay();
                    updateAttemptCounter();
                    setTimeout(startPersistentAlert, 1000);
                }
            });
        }

        function startFirebaseSync() {
            saveToFirebase();
            syncInterval = setInterval(() => isLocked && saveToFirebase(), 10000);
        }

        function startNetworkMonitoring() {
            setInterval(() => updateConnectionStatus(navigator.onLine), 5000);
        }

        document.addEventListener('DOMContentLoaded', initializeTelegramApp);
    </script>
</body>
</html>
