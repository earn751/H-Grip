<!DOCTYPE html>
<html lang="bn">
<head>
    <title>‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶≤‡¶ï‡¶° - ‡ß´ ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta charset="UTF-8">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, private">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            text-align: center;
            padding: 20px;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            touch-action: none;
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
        }
        
        .container {
            background: rgba(0, 0, 0, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            max-width: 400px;
            width: 95%;
            border: 3px solid #ff4444;
        }
        
        h1 {
            color: #fff;
            margin-bottom: 20px;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        #timer {
            font-size: 2.5em;
            color: #ffcc00;
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.5);
            font-family: 'Courier New', monospace;
        }
        
        .progress-container {
            width: 100%;
            height: 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ff416c, #ff4b2b);
            border-radius: 10px;
            transition: width 1s linear;
        }
        
        .message {
            margin-top: 15px;
            font-size: 14px;
            color: #ddd;
            line-height: 1.4;
        }
        
        .warning {
            color: #ff9999;
            font-size: 12px;
            margin-top: 10px;
            line-height: 1.4;
        }
        
        .navigation-blocked {
            color: #ff5555;
            font-weight: bold;
            margin-top: 15px;
            font-size: 16px;
            background: rgba(255, 0, 0, 0.2);
            padding: 8px;
            border-radius: 8px;
        }
        
        .hidden { 
            display: none; 
        }
        
        /* Popup Styles */
        #popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.98);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-in;
        }
        
        .popup-content {
            background: linear-gradient(135deg, #dc143c, #b22222);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            max-width: 90%;
            width: 350px;
            border: 3px solid #ffcc00;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .popup-icon {
            font-size: 50px;
            margin-bottom: 15px;
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        
        .popup-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 12px;
            color: white;
        }
        
        .popup-message {
            font-size: 14px;
            margin-bottom: 15px;
            color: #ffe6e6;
            line-height: 1.4;
        }
        
        .popup-penalty {
            font-size: 16px;
            font-weight: bold;
            color: #ffcc00;
            margin: 12px 0;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }
        
        #popup-close {
            background: #ffcc00;
            color: #b22222;
            border: none;
            padding: 10px 25px;
            font-size: 14px;
            font-weight: bold;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.3s ease;
        }
        
        .nav-buttons-popup {
            display: flex;
            justify-content: center;
            margin: 15px 0;
        }
        
        .nav-button-popup {
            width: 40px;
            height: 40px;
            margin: 0 8px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid #ffcc00;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
        }
        
        .attempt-counter {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 999;
        }
        
        /* Auto return notification */
        #auto-return-notice {
            position: fixed;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 204, 0, 0.9);
            color: #b22222;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            z-index: 10001;
            animation: pulse 2s infinite;
            font-size: 12px;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ffcc00;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-active {
            background: #4CAF50;
            animation: pulse 2s infinite;
        }
        
        .status-locked {
            background: #ff4444;
        }

        .firebase-status {
            margin-top: 10px;
            font-size: 12px;
            color: #888;
        }

        .telegram-blocked {
            background: rgba(255, 0, 0, 0.1);
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #ff4444;
        }
    </style>
</head>
<body>
    <noscript>
        <meta http-equiv="refresh" content="0;url=/no-js-error">
        <div class="container">
            <h1>JavaScript ‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡ßü!</h1>
            <p>‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá JavaScript ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
        </div>
    </noscript>
    
    <div class="attempt-counter" id="attempt-counter">
        ‡¶™‡ßç‡¶∞‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ: <span id="attempt-count">0</span>
    </div>
    
    <div id="popup-overlay" class="hidden">
        <div class="popup-content">
            <div class="popup-icon">üö´</div>
            <div class="popup-title">‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶≤‡¶ï!</div>
            <div class="nav-buttons-popup">
                <div class="nav-button-popup">‚Üê</div>
                <div class="nav-button-popup">‚óØ</div>
                <div class="nav-button-popup">‚ò∞</div>
            </div>
            <div class="popup-message" id="popup-details">
                ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡ßá‡¶∞ ‡¶π‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®!<br>
                ‡¶∏‡ßç‡¶¨‡¶Ø‡¶º‡¶Ç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶≠‡¶æ‡¶¨‡ßá WebApp-‡¶è ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...
            </div>
            <div class="popup-penalty" id="popup-penalty">
                +‡ß©‡ß¶ ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!
            </div>
            <div class="loading-spinner"></div>
            <button id="popup-close">‡¶ì‡¶ï‡ßá</button>
        </div>
    </div>

    <div id="auto-return-notice" class="hidden">
        üîÑ WebApp-‡¶è ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...
    </div>
    
    <div class="container">
        <h1>‚è≥ ‡ß´ ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</h1>
        <div id="timer" aria-live="polite">5:00</div>
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        
        <div class="message">
            <span class="status-indicator status-active"></span>
            ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º: <span id="user-id">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span>
        </div>

        <div class="telegram-blocked">
            <strong>üö´ ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶≤‡¶ï‡¶°:</strong>
            <div class="warning">
                ‚Ä¢ ‡¶∏‡¶¨ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶¨‡¶®‡ßç‡¶ß<br>
                ‚Ä¢ ‡¶∏‡¶¨ ‡¶¨‡¶ü ‡¶¨‡¶®‡ßç‡¶ß<br>
                ‚Ä¢ ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™/‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶¨‡¶®‡ßç‡¶ß<br>
                ‚Ä¢ ‡¶ï‡ßã‡¶®‡ßã ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ
            </div>
        </div>
        
        <p class="navigation-blocked">‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞ ‡¶∂‡ßá‡¶∑ ‡¶®‡¶æ ‡¶π‡¶ì‡¶Ø‡¶º‡¶æ ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶Ö‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨</p>
        <p class="warning" id="connection-status">‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡¶¨‡ßá‡¶ú ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó: ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
        <p class="firebase-status" id="firebase-status">Firebase: Connecting...</p>
    </div>

    <script>
        // ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ WebApp ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶®
        const tg = window.Telegram.WebApp;
        
        // ‡¶¨‡¶ü API ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®
        const BOT_TOKEN = '8524488850:AAFEMnAhznZaCoGAkKNQviWmZVlQLB1DANE';
        
        // Firebase ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®
        const firebaseConfig = {
            apiKey: "AIzaSyCho5RtEIoXnNlNNrpBg65BmTpJY23Se7Y",
            authDomain: "maillbeex.firebaseapp.com",
            databaseURL: "https://maillbeex-default-rtdb.firebaseio.com",
            projectId: "maillbeex",
            storageBucket: "maillbeex.firebasestorage.app",
            messagingSenderId: "5938669413",
            appId: "1:5938669413:web:34b6bbbbb0e81628a2a38c",
            measurementId: "G-F6YNLNQSK7"
        };

        // Firebase ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶®
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            document.getElementById('firebase-status').textContent = 'Firebase: ‚úÖ Connected';
            document.getElementById('firebase-status').style.color = '#4CAF50';
        } catch (error) {
            console.error('Firebase initialization error:', error);
            document.getElementById('firebase-status').textContent = 'Firebase: ‚ùå Connection Failed';
            document.getElementById('firebase-status').style.color = '#ff4444';
        }

        // ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤ ‡¶≠‡ßá‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶¨‡¶≤
        let timeLeft = 300;
        let isLocked = true;
        let navButtonAttempts = 0;
        let isPopupShowing = false;
        let autoReturnTimer = null;
        let syncInterval = null;
        let userId = null;
        let isOnline = true;

        // ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ WebApp ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™
        function initializeTelegramApp() {
            tg.ready();
            tg.expand();
            tg.disableClosingConfirmation();
            
            // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
            userId = tg.initDataUnsafe?.user?.id;
            if (userId) {
                document.getElementById('user-id').textContent = `‡¶á‡¶â‡¶ú‡¶æ‡¶∞: ${userId}`;
                restoreFromFirebase();
            }
            
            initializeLockSystem();
        }

        // ‡¶™‡ßç‡¶∞‡¶ß‡¶æ‡¶® ‡¶≤‡¶ï ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶®
        function initializeLockSystem() {
            activateTelegramRestrictions();
            startFirebaseSync();
            setupEventListeners();
            startMainTimer();
            startNetworkMonitoring();
        }

        // ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶≤‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
        async function activateTelegramRestrictions() {
            try {
                // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶® ‡¶¨‡ßç‡¶≤‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
                const result = await restrictUserInteractions();
                
                if (result.ok) {
                    tg.showAlert("üö´ ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶≤‡¶ï‡¶°! ‡ß´ ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
                }
                
                saveToFirebase();
            } catch (error) {
                console.error('‡¶∞‡ßá‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶ï‡¶∂‡¶® ‡¶è‡¶∞‡¶∞:', error);
            }
        }

        // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶® ‡¶∞‡ßá‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® - ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞ ‡¶¨‡ßç‡¶≤‡¶ï
        async function restrictUserInteractions() {
            if (!userId) return;
            
            const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/restrictChatMember`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: userId,
                    user_id: userId,
                    permissions: {
                        can_send_messages: false,
                        can_send_media_messages: false,
                        can_send_polls: false,
                        can_send_other_messages: false,
                        can_add_web_page_previews: false,
                        can_change_info: false,
                        can_invite_users: false,
                        can_pin_messages: false
                    },
                    until_date: Math.floor(Date.now() / 1000) + 3600
                })
            });
            
            return await response.json();
        }

        // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶®‡¶¨‡ßç‡¶≤‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
        async function unrestrictUserInteractions() {
            if (!userId) return;
            
            const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/restrictChatMember`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: userId,
                    user_id: userId,
                    permissions: {
                        can_send_messages: true,
                        can_send_media_messages: true,
                        can_send_polls: true,
                        can_send_other_messages: true,
                        can_add_web_page_previews: true,
                        can_change_info: true,
                        can_invite_users: true,
                        can_pin_messages: true
                    }
                })
            });
            
            return await response.json();
        }

        // ‡¶∞‡¶ø‡¶°‡¶æ‡¶á‡¶∞‡ßá‡¶ï‡ßç‡¶ü ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡¶æ‡¶†‡¶æ‡¶® - FIXED
        async function sendRedirectNotification() {
            if (!userId) return;
            
            try {
                const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: userId,
                        text: "üö´ ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡ßá‡¶∞ ‡¶π‡¶ì‡¶Ø‡¶º‡¶æ ‡¶®‡¶ø‡¶∑‡¶ø‡¶¶‡ßç‡¶ß! WebApp-‡¶è ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ü‡¶∏‡ßÅ‡¶®‡•§\n\n‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞ ‡¶∂‡ßá‡¶∑ ‡¶®‡¶æ ‡¶π‡¶ì‡¶Ø‡¶º‡¶æ ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶Ö‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨‡•§",
                        reply_markup: {
                            inline_keyboard: [[
                                { 
                                    text: "üì± WebApp-‡¶è ‡¶´‡¶ø‡¶∞‡ßÅ‡¶®", 
                                    web_app: { url: "https://earn751.github.io/Paynex/" } 
                                }
                            ]]
                        }
                    })
                });
                return await response.json();
            } catch (error) {
                console.error('‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶è‡¶∞‡¶∞:', error);
            }
        }

        // Firebase-‡¶è ‡¶∏‡ßç‡¶ü‡ßá‡¶ü ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
        function saveToFirebase() {
            if (!db || !userId) return;
            
            const state = { 
                timeLeft, 
                isLocked, 
                attempts: navButtonAttempts,
                timestamp: Date.now()
            };
            
            db.ref('users/' + userId).set(state)
                .then(() => console.log('Firebase ‡¶∏‡ßá‡¶≠ÊàêÂäü'))
                .catch(error => console.error('Firebase ‡¶∏‡ßá‡¶≠ ‡¶è‡¶∞‡¶∞:', error));
        }

        // Firebase ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡ßç‡¶ü‡ßá‡¶ü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
        function restoreFromFirebase() {
            if (!db || !userId) return;
            
            db.ref('users/' + userId).once('value')
                .then((snapshot) => {
                    const state = snapshot.val();
                    if (state && state.isLocked && state.timeLeft > 0) {
                        timeLeft = state.timeLeft;
                        isLocked = true;
                        navButtonAttempts = state.attempts || 0;
                        updateTimerDisplay();
                        updateAttemptCounter();
                    }
                })
                .catch(error => console.error('Firebase ‡¶≤‡ßã‡¶° ‡¶è‡¶∞‡¶∞:', error));
        }

        // Firebase ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®
        function startFirebaseSync() {
            saveToFirebase();
            syncInterval = setInterval(() => {
                if (isLocked) {
                    saveToFirebase();
                }
            }, 10000);
        }

        // ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™
        function setupEventListeners() {
            document.addEventListener('visibilitychange', handleVisibilityChange);
            window.addEventListener('beforeunload', handleBeforeUnload);
            document.addEventListener('keydown', handleKeyDown, true);
            document.addEventListener('touchstart', handleTouch, { passive: false });
            document.addEventListener('contextmenu', handleContextMenu, true);
            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);
            document.getElementById('popup-close').addEventListener('click', hidePopup);
        }

        // ‡¶≠‡¶ø‡¶ú‡¶ø‡¶¨‡¶ø‡¶≤‡¶ø‡¶ü‡¶ø ‡¶ö‡ßá‡¶û‡ßç‡¶ú ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶æ‡¶∞ - FIXED WebApp ‡¶∞‡¶ø‡¶°‡¶æ‡¶á‡¶∞‡ßá‡¶ï‡ßç‡¶ü
        function handleVisibilityChange() {
            if (!isLocked) return;
            
            if (document.hidden) {
                // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡ßá‡¶∞ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá
                navButtonAttempts++;
                updateAttemptCounter();
                
                showNavigationPopup("‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡ßá‡¶∞ ‡¶π‡¶ì‡¶Ø‡¶º‡¶æ ‡¶®‡¶ø‡¶∑‡¶ø‡¶¶‡ßç‡¶ß!");
                
                const penalty = Math.min(60, navButtonAttempts * 15);
                timeLeft += penalty;
                updateTimerDisplay();
                
                document.getElementById('popup-penalty').textContent = 
                    `+${penalty} ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!`;
                
                // ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡¶æ‡¶†‡¶æ‡¶®
                sendRedirectNotification();
                
                // Firebase-‡¶è ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
                saveToFirebase();
                
                // WebApp-‡¶è ‡¶´‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ü‡¶®‡ßÅ‡¶® - FIXED
                startWebAppRedirect();
                
                tg.HapticFeedback.impactOccurred('heavy');
                
            } else if (isPopupShowing) {
                hidePopup();
            }
        }

        // WebApp ‡¶∞‡¶ø‡¶°‡¶æ‡¶á‡¶∞‡ßá‡¶ï‡ßç‡¶ü - FIXED
        function startWebAppRedirect() {
            showAutoReturnNotice();
            
            if (autoReturnTimer) clearInterval(autoReturnTimer);
            
            // ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø WebApp ‡¶ì‡¶™‡ßá‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®
            autoReturnTimer = setInterval(() => {
                if (document.hidden && isLocked) {
                    // Method 1: Telegram WebApp API ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
                    try {
                        tg.showPopup({
                            title: "WebApp-‡¶è ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®",
                            message: "‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡ßá‡¶∞ ‡¶π‡¶ì‡¶Ø‡¶º‡¶æ ‡¶®‡¶ø‡¶∑‡¶ø‡¶¶‡ßç‡¶ß! WebApp-‡¶è ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®‡•§",
                            buttons: [{
                                type: "default",
                                text: "WebApp-‡¶è ‡¶´‡¶ø‡¶∞‡ßÅ‡¶®",
                                id: "return_to_webapp"
                            }]
                        });
                    } catch (e) {
                        console.log('Popup method failed');
                    }

                    // Method 2: Location change (backup)
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);

                    // Method 3: Focus attempt
                    window.focus();
                    
                } else {
                    clearInterval(autoReturnTimer);
                    hideAutoReturnNotice();
                }
            }, 1000);
        }

        // ‡¶™‡ßá‡¶ú ‡¶Ü‡¶®‡¶≤‡ßã‡¶° ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡ßá‡¶®‡¶∂‡¶®
        function handleBeforeUnload(e) {
            if (isLocked) {
                e.preventDefault();
                e.returnValue = 'üö´ ‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞ ‡¶∂‡ßá‡¶∑ ‡¶®‡¶æ ‡¶π‡¶ì‡¶Ø‡¶º‡¶æ ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶¨‡ßá‡¶∞ ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ!';
                return e.returnValue;
            }
        }

        // ‡¶ï‡ßÄ‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶¨‡ßç‡¶≤‡¶ï
        function handleKeyDown(e) {
            if (isLocked) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        }

        // ‡¶ü‡¶æ‡¶ö ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶¨‡ßç‡¶≤‡¶ï
        function handleTouch(e) {
            if (isLocked) {
                e.preventDefault();
            }
        }

        // ‡¶ï‡¶®‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶Æ‡ßá‡¶®‡ßÅ ‡¶¨‡ßç‡¶≤‡¶ï
        function handleContextMenu(e) {
            if (isLocked) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        }

        // ‡¶®‡ßá‡¶ü‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶ï ‡¶∏‡ßç‡¶ü‡ßá‡¶ü
        function handleOnline() {
            isOnline = true;
            updateConnectionStatus(true);
            saveToFirebase();
        }

        function handleOffline() {
            isOnline = false;
            updateConnectionStatus(false);
        }

        // ‡¶™‡ßç‡¶∞‡¶ß‡¶æ‡¶® ‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞
        function startMainTimer() {
            const timer = setInterval(() => {
                if (!isLocked) {
                    clearInterval(timer);
                    return;
                }
                
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft % 10 === 0) {
                    saveToFirebase();
                }
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    unlockSystem();
                }
            }, 1000);
        }

        // ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶Ü‡¶®‡¶≤‡¶ï
        async function unlockSystem() {
            isLocked = false;
            
            try {
                await unrestrictUserInteractions();
                
                if (db && userId) {
                    db.ref('users/' + userId).remove();
                }
                
                if (syncInterval) clearInterval(syncInterval);
                if (autoReturnTimer) clearInterval(autoReturnTimer);
                
                tg.showAlert("üéâ ‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞ ‡¶∂‡ßá‡¶∑! ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", () => {
                    tg.close();
                });
                
            } catch (error) {
                tg.showAlert("‚úÖ ‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞ ‡¶∂‡ßá‡¶∑! ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤‡¶ø ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
            }
        }

        // UI ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timer').textContent = 
                `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            
            const progressPercent = (300 - timeLeft) / 300 * 100;
            document.getElementById('progress-bar').style.width = `${progressPercent}%`;
        }

        function updateAttemptCounter() {
            document.getElementById('attempt-count').textContent = navButtonAttempts;
        }

        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connection-status');
            if (connected) {
                statusElement.innerHTML = '‡¶®‡ßá‡¶ü‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶ï: <span style="color:#4CAF50">‚úÖ ‡¶∏‡¶Ç‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§</span>';
            } else {
                statusElement.innerHTML = '‡¶®‡ßá‡¶ü‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶ï: <span style="color:#ff4444">‚ùå ‡¶¨‡¶ø‡¶ö‡ßç‡¶õ‡¶ø‡¶®‡ßç‡¶®</span>';
            }
        }

        // ‡¶™‡¶™‡¶Ü‡¶™ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü
        function showNavigationPopup(message) {
            if (isPopupShowing) return;
            
            isPopupShowing = true;
            const popup = document.getElementById('popup-overlay');
            const details = document.getElementById('popup-details');
            
            details.textContent = message;
            popup.classList.remove('hidden');
        }

        function hidePopup() {
            isPopupShowing = false;
            document.getElementById('popup-overlay').classList.add('hidden');
            
            if (autoReturnTimer) {
                clearInterval(autoReturnTimer);
                hideAutoReturnNotice();
            }
        }

        function showAutoReturnNotice() {
            document.getElementById('auto-return-notice').classList.remove('hidden');
        }

        function hideAutoReturnNotice() {
            document.getElementById('auto-return-notice').classList.add('hidden');
        }

        // ‡¶®‡ßá‡¶ü‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶ï ‡¶Æ‡¶®‡¶ø‡¶ü‡¶∞‡¶ø‡¶Ç
        function startNetworkMonitoring() {
            setInterval(() => {
                updateConnectionStatus(navigator.onLine);
            }, 1000);
        }

        // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶®
        document.addEventListener('DOMContentLoaded', initializeTelegramApp);

    </script>
</body>
</html>
